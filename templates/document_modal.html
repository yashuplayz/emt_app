<div class="modal-header bg-white text-danger">
    <h5 class="modal-title fw-bold">{{ doc.request_id }}</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"
        onclick="window.location.reload()"></button>
</div>

<div class="modal-body bg-light p-3">
    <div class="accordion" id="modalAccordion">

        <!-- Document Details -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#mc1">
                    Document Details
                </button>
            </h2>
            <div id="mc1" class="accordion-collapse collapse show" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Project No</label>
                            <input type="text" class="form-control" value="{{ doc.project_no }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Document No</label>
                            <input type="text" class="form-control" value="{{ doc.doc_number }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Revision</label>
                            <input type="text" class="form-control" value="{{ doc.revision_number }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Title</label>
                            <input type="text" class="form-control" value="{{ doc.title }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Discipline</label>
                            <input type="text" class="form-control" value="{{ doc.discipline }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Baseline Date</label>
                            <input type="text" class="form-control" value="{{ doc.baseline_date }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Est. Hours</label>
                            <input type="text" class="form-control" value="{{ doc.estimation_hours }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">IDR Required?</label>
                            <input type="text" class="form-control" value="{{ doc.is_idr_required }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">SignOff Req?</label>
                            <input type="text" class="form-control" value="{{ doc.is_signoff_required }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Doc Owner</label>
                            <input type="text" class="form-control" value="{{ doc.doc_owner }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Originator</label>
                            <input type="text" class="form-control" value="{{ doc.originator }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Reviewer</label>
                            <input type="text" class="form-control" value="{{ doc.reviewer }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">SignOff Eng</label>
                            <input type="text" class="form-control" value="{{ doc.signoff_eng }}" disabled>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">DRM Category</label>
                            <input type="text" class="form-control" value="{{ doc.drm_category }}" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Originator Cycle 1 -->
        {% if doc.current_stage_code >= 1 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {{ 'collapsed' if doc.current_stage_code != 1 }}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#moc1">
                    Originator Cycle 1
                    {% if doc.current_stage_code > 1 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 1 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="moc1" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 1 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/OriginatorCycle_1" method="POST">
                        {% set data = cycles['OriginatorCycle_1'] if 'OriginatorCycle_1' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 1 and current_user == doc.originator) %}

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Actual Hours</label>
                                <input type="number" step="0.1" name="actual_hours" class="form-control"
                                    value="{{ data.actual_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transmittal Date</label>
                                <input type="date" name="transmittal_date" class="form-control"
                                    value="{{ data.transmittal_date if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Ref Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Description / Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-danger">Submit</button></div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Reviewer Cycle 1 -->
        {% if 'ReviewerCycle_1' in cycles or doc.current_stage_code == 2 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button {{ 'collapsed' if doc.current_stage_code != 2 }}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#mrc1">
                    Reviewer Cycle 1
                    {% if doc.current_stage_code > 2 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 2 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="mrc1" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 2 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/ReviewerCycle_1" method="POST">
                        {% set data = cycles['ReviewerCycle_1'] if 'ReviewerCycle_1' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 2 and current_user in doc.reviewer) %}

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Reviewer Action</label>
                                <select name="action" class="form-select" {{ 'disabled' if not is_editable }}>
                                    <option>Accepted</option>
                                    <option>SendBack</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Review Hours</label>
                                <input type="number" step="0.1" name="review_hours" class="form-control"
                                    value="{{ data.review_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Major Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Tool</span><input
                                        type="number" name="major_tool" class="form-control"
                                        value="{{ data.major_tool if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Tech</span><input
                                        type="number" name="major_tech" class="form-control"
                                        value="{{ data.major_tech if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Std</span><input
                                        type="number" name="major_std" class="form-control"
                                        value="{{ data.major_std if data else 0 }}" {{ 'disabled' if not is_editable }}>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Minor Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Typo</span><input
                                        type="number" name="minor_typo" class="form-control"
                                        value="{{ data.minor_typo if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Document Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Reviewer Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-primary">Submit Review</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Originator Cycle 2 -->
        {% if 'OriginatorCycle_2' in cycles or doc.current_stage_code == 3 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#moc2">
                    Originator Cycle 2
                    {% if doc.current_stage_code > 3 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 3 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="moc2" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 3 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/OriginatorCycle_2" method="POST">
                        {% set data = cycles['OriginatorCycle_2'] if 'OriginatorCycle_2' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 3 and current_user == doc.originator) %}

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Actual Hours</label>
                                <input type="number" step="0.1" name="actual_hours" class="form-control"
                                    value="{{ data.actual_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transmittal Date</label>
                                <input type="date" name="transmittal_date" class="form-control"
                                    value="{{ data.transmittal_date if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Ref Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Description / Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-danger">Submit</button></div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Reviewer Cycle 2 -->
        {% if 'ReviewerCycle_2' in cycles or doc.current_stage_code == 4 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#mrc2">
                    Reviewer Cycle 2
                    {% if doc.current_stage_code > 4 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 4 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="mrc2" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 4 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/ReviewerCycle_2" method="POST">
                        {% set data = cycles['ReviewerCycle_2'] if 'ReviewerCycle_2' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 4 and current_user in doc.reviewer) %}

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Reviewer Action</label>
                                <select name="action" class="form-select" {{ 'disabled' if not is_editable }}>
                                    <option>Accepted</option>
                                    <option>SendBack</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Review Hours</label>
                                <input type="number" step="0.1" name="review_hours" class="form-control"
                                    value="{{ data.review_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Document Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Major Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Tool</span><input
                                        type="number" name="major_tool" class="form-control"
                                        value="{{ data.major_tool if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Tech</span><input
                                        type="number" name="major_tech" class="form-control"
                                        value="{{ data.major_tech if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Std</span><input
                                        type="number" name="major_std" class="form-control"
                                        value="{{ data.major_std if data else 0 }}" {{ 'disabled' if not is_editable }}>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Minor Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Typo</span><input
                                        type="number" name="minor_typo" class="form-control"
                                        value="{{ data.minor_typo if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Reviewer Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-primary">Submit Review</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Originator Cycle 3 -->
        {% if 'OriginatorCycle_3' in cycles or doc.current_stage_code == 5 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#moc3">
                    Originator Cycle 3
                    {% if doc.current_stage_code > 5 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 5 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="moc3" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 5 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/OriginatorCycle_3" method="POST">
                        {% set data = cycles['OriginatorCycle_3'] if 'OriginatorCycle_3' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 5 and current_user == doc.originator) %}

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Actual Hours</label>
                                <input type="number" step="0.1" name="actual_hours" class="form-control"
                                    value="{{ data.actual_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transmittal Date</label>
                                <input type="date" name="transmittal_date" class="form-control"
                                    value="{{ data.transmittal_date if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Ref Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Description / Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-danger">Submit</button></div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Reviewer Cycle 3 -->
        {% if 'ReviewerCycle_3' in cycles or doc.current_stage_code == 6 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#mrc3">
                    Reviewer Cycle 3
                    {% if doc.current_stage_code > 6 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 6 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="mrc3" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 6 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/ReviewerCycle_3" method="POST">
                        {% set data = cycles['ReviewerCycle_3'] if 'ReviewerCycle_3' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 6 and current_user in doc.reviewer) %}

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Reviewer Action</label>
                                <select name="action" class="form-select" {{ 'disabled' if not is_editable }}>
                                    <option>Accepted</option>
                                    <option>SendBack</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Review Hours</label>
                                <input type="number" step="0.1" name="review_hours" class="form-control"
                                    value="{{ data.review_hours if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Document Link</label>
                                <input type="text" name="ref_link" class="form-control"
                                    value="{{ data.ref_link if data }}" {{ 'disabled' if not is_editable }}>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Major Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Tool</span><input
                                        type="number" name="major_tool" class="form-control"
                                        value="{{ data.major_tool if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Tech</span><input
                                        type="number" name="major_tech" class="form-control"
                                        value="{{ data.major_tech if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                                <div class="input-group mb-2"><span class="input-group-text">Std</span><input
                                        type="number" name="major_std" class="form-control"
                                        value="{{ data.major_std if data else 0 }}" {{ 'disabled' if not is_editable }}>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-primary">Minor Issues</label>
                                <div class="input-group mb-2"><span class="input-group-text">Typo</span><input
                                        type="number" name="minor_typo" class="form-control"
                                        value="{{ data.minor_typo if data else 0 }}" {{ 'disabled' if not is_editable
                                        }}></div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Reviewer Comments</label>
                                <textarea name="description" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.description if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-primary">Submit Review</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- IDR Review -->
        {% if (idr_reviews and idr_reviews|length > 0) or doc.current_stage_code == 7 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#midr">
                    IDR Review
                    {% if doc.current_stage_code > 7 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 7 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="midr" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 7 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/IDR_Review" method="POST">
                        <div class="mb-3">
                            <h6 class="text-danger fw-bold">Note:</h6>
                            <p class="text-danger small mb-0">*Major Issues: Design errors, Safety risks, Code or
                                standard violations or unclear requirements, Calculations errors, Etc</p>
                            <p class="text-danger small">*Minor Issues: Typographical errors, Non standard terminology,
                                Minor things which do not impact the project requirement, Etc</p>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Reviewer Name</th>
                                        <th style="width: 120px;">Review Hours</th>
                                        <th>Major Issues Reported</th>
                                        <th>Minor Issues Reported</th>
                                        <th>Link To Reviewer Commented</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for review in idr_reviews %}
                                    <tr>
                                        <td>{{ review.reviewer_email }}</td>
                                        {% if current_user == review.reviewer_email and review.status != 'Submitted' %}
                                        <!-- Editable Row for Current User -->
                                        <td>
                                            <input type="number" step="0.1" name="review_hours" class="form-control"
                                                placeholder="Enter Hours"
                                                value="{{ review.review_hours if review.review_hours else '' }}"
                                                required>
                                        </td>
                                        <td>
                                            <input type="text" name="major_issues" class="form-control"
                                                placeholder="Enter Major Issues"
                                                value="{{ review.major_issues if review.major_issues else '' }}">
                                        </td>
                                        <td>
                                            <input type="text" name="minor_issues" class="form-control"
                                                placeholder="Enter Minor Issues"
                                                value="{{ review.minor_issues if review.minor_issues else '' }}">
                                        </td>
                                        <td>
                                            <input type="text" name="comment_link" class="form-control"
                                                placeholder="Enter Document Link"
                                                value="{{ review.comment_link if review.comment_link else '' }}">
                                        </td>
                                        {% else %}
                                        <!-- Read-Only Row for Others or Submitted -->
                                        <td>
                                            <input type="text" class="form-control"
                                                value="{{ review.review_hours if review.review_hours else '-' }}"
                                                disabled>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control"
                                                value="{{ review.major_issues if review.major_issues else '-' }}"
                                                disabled>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control"
                                                value="{{ review.minor_issues if review.minor_issues else '-' }}"
                                                disabled>
                                        </td>
                                        <td>
                                            {% if review.comment_link %}
                                            <a href="{{ review.comment_link }}" target="_blank">View
                                                Link</a>
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if doc.current_stage_code == 7 %}
                        {% set my_review = idr_reviews | selectattr("reviewer_email", "equalto",
                        current_user) |
                        first
                        %}
                        {% if my_review and my_review.status != 'Submitted' %}
                        <div class="mt-3 text-end">
                            <button type="submit" class="btn btn-primary">Submit Review</button>
                        </div>
                        {% endif %}
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- SignOff Engineer -->
        {% if 'SignOffEngineer' in cycles or doc.current_stage_code == 8 %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    data-bs-target="#msignoff">
                    SignOff Engineer
                    {% if doc.current_stage_code > 8 %} <span class="badge bg-success ms-2">Submitted</span>
                    {% elif doc.current_stage_code == 8 %} <span class="badge bg-warning text-dark ms-2">Pending</span>
                    {% endif %}
                </button>
            </h2>
            <div id="msignoff" class="accordion-collapse collapse {{ 'show' if doc.current_stage_code == 8 }}"
                data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                    <form action="/submit_cycle/{{doc.id}}/SignOffEngineer" method="POST">
                        {% set data = cycles['SignOffEngineer'] if 'SignOffEngineer' in cycles else None %}
                        {% set is_editable = (doc.current_stage_code == 8 and current_user == doc.signoff_eng) %}

                        <!-- Summary Table -->
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Document</th>
                                        <th>Cycle_1</th>
                                        <th>Cycle_2</th>
                                        <th>Cycle_3</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Originator's Document Link</td>
                                        <td>
                                            {% if 'OriginatorCycle_1' in cycles and cycles['OriginatorCycle_1'].ref_link
                                            %}
                                            <a href="{{ cycles['OriginatorCycle_1'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if 'OriginatorCycle_2' in cycles and cycles['OriginatorCycle_2'].ref_link
                                            %}
                                            <a href="{{ cycles['OriginatorCycle_2'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if 'OriginatorCycle_3' in cycles and cycles['OriginatorCycle_3'].ref_link
                                            %}
                                            <a href="{{ cycles['OriginatorCycle_3'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Reviewer's Document Link</td>
                                        <td>
                                            {% if 'ReviewerCycle_1' in cycles and cycles['ReviewerCycle_1'].ref_link %}
                                            <a href="{{ cycles['ReviewerCycle_1'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if 'ReviewerCycle_2' in cycles and cycles['ReviewerCycle_2'].ref_link %}
                                            <a href="{{ cycles['ReviewerCycle_2'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if 'ReviewerCycle_3' in cycles and cycles['ReviewerCycle_3'].ref_link %}
                                            <a href="{{ cycles['ReviewerCycle_3'].ref_link }}" target="_blank">Click
                                                here</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">TimeStamp (Auto Update)</label>
                                <input type="text" class="form-control"
                                    value="{{ data.timestamp.strftime('%m/%d/%Y') if data else 'mm/dd/yyyy' }}"
                                    disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">SignOff Engineer Decision</label>
                                <select name="signoff_decision" class="form-select" {{ 'disabled' if not is_editable }}>
                                    <option value="" selected disabled>Nothing selected</option>
                                    <option value="Approved" {{ 'selected' if data and data.signoff_decision=='Approved'
                                        }}>Approved</option>
                                    <option value="Hold" {{ 'selected' if data and data.signoff_decision=='Hold' }}>Hold
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Spent Hours</label>
                                <input type="number" step="0.1" name="signoff_hours" class="form-control"
                                    placeholder="Enter Spent Hours" value="{{ data.signoff_hours if data }}"
                                    {{ 'disabled' if not is_editable }}>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">SignOff Engineer Comments</label>
                                <textarea name="signoff_comments" class="form-control" rows="3" {{ 'disabled' if not
                                    is_editable }}>{{ data.signoff_comments if data }}</textarea>
                            </div>
                        </div>
                        {% if is_editable %}
                        <div class="mt-3 text-end"><button type="submit" class="btn btn-success">Complete
                                SignOff</button></div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<div class="modal-footer bg-white">
    {% if (current_user == doc.doc_owner or current_user == doc.originator) and doc.record_status ==
    "Active" %}
    <a href="/delete/{{doc.id}}" class="btn btn-outline-danger me-auto"
        onclick="return confirm('Mark INACTIVE?')">Delete Request</a>
    {% endif %}
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
        onclick="window.location.reload()">Close</button>
</div>